{% extends "base.html" %}

{% block title %}{% if is_new %}New Notification{% else %}Edit {{ name }}{% endif %} - Discord Notifier{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{% if is_new %}New Notification{% else %}{{ name }}{% endif %}</h1>
    {% if not is_new %}
        <p class="subtitle">
            {% if enabled %}
                <span class="badge badge-success">Enabled</span>
                {{ schedule_human or schedule }}
                {% if next_run %}Â· Next run: {{ next_run.strftime('%b %d at %H:%M') }}{% endif %}
            {% else %}
                <span class="badge badge-muted">Disabled</span>
            {% endif %}
        </p>
    {% endif %}
</div>

<div class="edit-layout">
    <div class="edit-main">
        <form method="post" class="card">
            <h2>Configuration</h2>
            
            {% if is_new %}
                <div class="form-group">
                    <label for="name">Name</label>
                    <input type="text" id="name" name="name" value="{{ name }}" 
                           placeholder="my-notification" pattern="[a-zA-Z0-9_-]+"
                           required>
                    <p class="hint">Letters, numbers, dashes, and underscores only.</p>
                </div>
            {% endif %}

            <div class="form-group">
                <label for="webhook_url">Webhook URL</label>
                <input type="url" id="webhook_url" name="webhook_url" value="{{ webhook_url }}"
                       placeholder="https://discord.com/api/webhooks/..."
                       required>
            </div>

            <div class="form-group">
                <label for="message">Message</label>
                <textarea id="message" name="message" placeholder="Your notification message...
                
Use {date} for today's date (DD/MM/YYYY)
Use {date:DD/MM} for short date format">{{ message }}</textarea>
                <p class="hint">Supports date placeholders: <code>{date}</code>, <code>{date:DD/MM}</code>, <code>{date:DD/MM/YYYY}</code></p>
            </div>

            <div class="btn-group">
                <button type="submit" name="action" value="save" class="btn btn-primary">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M.143 2.31a.75.75 0 0 1 1.047-.167l14.5 10.5a.75.75 0 1 1-.88 1.214l-2.248-1.628C11.346 13.19 9.792 14 8 14c-4.296 0-7.4-4.18-7.806-4.789l-.062-.09a.75.75 0 0 1 0-.832C.442 7.861 3.5 3.5 8 3.5c1.37 0 2.593.391 3.632 1.038l-2.063-1.494A.75.75 0 0 1 .143 2.31Z"/>
                    </svg>
                    Save Configuration
                </button>
            </div>
        </form>

        {% if not is_new %}
            <div class="card">
                <h2>Schedule</h2>
                <form method="post">
                    <div class="form-group">
                        <label for="schedule">Run Time</label>
                        <select id="schedule" name="schedule">
                            {% for key, preset in presets.items() %}
                                <option value="{{ preset.cron }}" {% if schedule == preset.cron %}selected{% endif %}>
                                    {{ preset.label }}
                                </option>
                            {% endfor %}
                            <option value="custom" {% if schedule not in presets.values()|map(attribute='cron') %}selected{% endif %}>
                                Custom...
                            </option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="custom-schedule-group" style="display: none;">
                        <label for="custom_schedule">Custom Cron Expression</label>
                        <input type="text" id="custom_schedule" name="custom_schedule" 
                               value="{{ schedule }}" placeholder="0 9 * * *" class="mono">
                        <p class="hint">Format: minute hour day month weekday (e.g., 0 9 * * 1-5 for weekdays at 9 AM)</p>
                    </div>

                    <div class="btn-group">
                        {% if enabled %}
                            <button type="submit" name="action" value="update_schedule" class="btn btn-secondary">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                    <path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Zm7-3.25v2.992l2.028.812a.75.75 0 0 1-.557 1.392l-2.5-1A.751.751 0 0 1 7 8.25v-3.5a.75.75 0 0 1 1.5 0Z"/>
                                </svg>
                                Update Schedule
                            </button>
                            <button type="submit" name="action" value="disable" class="btn btn-danger">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                    <path d="M4.47.22A.749.749 0 0 1 5 0h6c.199 0 .389.079.53.22l4.25 4.25c.141.14.22.331.22.53v6a.749.749 0 0 1-.22.53l-4.25 4.25A.749.749 0 0 1 11 16H5a.749.749 0 0 1-.53-.22L.22 11.53A.749.749 0 0 1 0 11V5c0-.199.079-.389.22-.53Zm.84 1.28L1.5 5.31v5.38l3.81 3.81h5.38l3.81-3.81V5.31L10.69 1.5ZM8 4a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 8 4Zm0 8a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"/>
                                </svg>
                                Disable
                            </button>
                        {% else %}
                            <button type="submit" name="action" value="enable" class="btn btn-success">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                    <path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Zm4.879-2.773 4.264 2.559a.25.25 0 0 1 0 .428l-4.264 2.559A.25.25 0 0 1 6 10.559V5.442a.25.25 0 0 1 .379-.215Z"/>
                                </svg>
                                Enable Notification
                            </button>
                        {% endif %}
                    </div>
                </form>
            </div>
        {% endif %}
    </div>

    <div class="edit-sidebar">
        {% if not is_new %}
            <div class="card">
                <h2>Actions</h2>
                <div class="action-buttons">
                    <form method="post" action="{{ url_for('main.test_notification', name=name) }}">
                        <button type="submit" class="btn btn-secondary" style="width: 100%;">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Zm4.879-2.773 4.264 2.559a.25.25 0 0 1 0 .428l-4.264 2.559A.25.25 0 0 1 6 10.559V5.442a.25.25 0 0 1 .379-.215Z"/>
                            </svg>
                            Send Test
                        </button>
                    </form>
                    
                    <form method="post" action="{{ url_for('main.delete_notification', name=name) }}"
                          onsubmit="return confirm('Are you sure you want to delete this notification?');">
                        <button type="submit" class="btn btn-danger" style="width: 100%;">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M11 1.75V3h2.25a.75.75 0 0 1 0 1.5H2.75a.75.75 0 0 1 0-1.5H5V1.75C5 .784 5.784 0 6.75 0h2.5C10.216 0 11 .784 11 1.75ZM4.496 6.675l.66 6.6a.25.25 0 0 0 .249.225h5.19a.25.25 0 0 0 .249-.225l.66-6.6a.75.75 0 0 1 1.492.149l-.66 6.6A1.748 1.748 0 0 1 10.595 15h-5.19a1.75 1.75 0 0 1-1.741-1.575l-.66-6.6a.75.75 0 1 1 1.492-.15ZM6.5 1.75V3h3V1.75a.25.25 0 0 0-.25-.25h-2.5a.25.25 0 0 0-.25.25Z"/>
                            </svg>
                            Delete
                        </button>
                    </form>
                </div>
            </div>

            {% if message_preview %}
                <div class="card">
                    <h2>Message Preview</h2>
                    <div class="preview-box">{{ message_preview }}</div>
                    <p class="hint mt-1">Date placeholders replaced with current date.</p>
                </div>
            {% endif %}
        {% endif %}
    </div>
</div>

<style>
    .edit-layout {
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: 1.5rem;
        align-items: start;
    }

    @media (max-width: 900px) {
        .edit-layout {
            grid-template-columns: 1fr;
        }
    }

    .edit-main .card {
        margin-bottom: 1rem;
    }

    .edit-sidebar .card {
        margin-bottom: 1rem;
    }

    .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .preview-box {
        background: var(--bg-primary);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 1rem;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.85rem;
        white-space: pre-wrap;
        max-height: 200px;
        overflow-y: auto;
    }

    code {
        background: var(--bg-tertiary);
        padding: 0.125rem 0.375rem;
        border-radius: 4px;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.85em;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    const scheduleSelect = document.getElementById('schedule');
    const customGroup = document.getElementById('custom-schedule-group');
    const customInput = document.getElementById('custom_schedule');

    function toggleCustomSchedule() {
        if (scheduleSelect && customGroup) {
            if (scheduleSelect.value === 'custom') {
                customGroup.style.display = 'block';
            } else {
                customGroup.style.display = 'none';
                if (customInput) {
                    customInput.value = scheduleSelect.value;
                }
            }
        }
    }

    if (scheduleSelect) {
        scheduleSelect.addEventListener('change', toggleCustomSchedule);
        toggleCustomSchedule();
    }

    // Override schedule value on form submit if custom is selected
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', function() {
            if (scheduleSelect && scheduleSelect.value === 'custom' && customInput) {
                // Create hidden input with custom value
                const hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.name = 'schedule';
                hidden.value = customInput.value;
                form.appendChild(hidden);
            }
        });
    });
</script>
{% endblock %}

